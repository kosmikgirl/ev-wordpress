import SweetAlert from"sweetalert2";import Sortable from"sortablejs";import*as lpUtils from"lpAssetsJsPath/utils.js";import*as lpToastify from"lpAssetsJsPath/lpToastify.js";import{EditSectionItem}from"./edit-section-item.js";import{EditCourseCurriculum}from"../edit-curriculum.js";export class EditSection{constructor(){this.courseId=null,this.elEditCurriculum=null,this.elCurriculumSections=null,this.editSectionItem=new EditSectionItem}static selectors={elSection:".section",elDivAddNewSection:".add-new-section",elSectionClone:".section.clone",elSectionTitleNewInput:".lp-section-title-new-input",elSectionTitleInput:".lp-section-title-input",etBtnEditTitle:".lp-btn-edit-section-title",elSectionDesInput:".lp-section-description-input",elBtnAddSection:".lp-btn-add-section",elBtnUpdateTitle:".lp-btn-update-section-title",elBtnUpdateDes:".lp-btn-update-section-description",elBtnCancelUpdateTitle:".lp-btn-cancel-update-section-title",elBtnCancelUpdateDes:".lp-btn-cancel-update-section-description",elBtnDeleteSection:".lp-btn-delete-section",elSectionDesc:".section-description",elSectionToggle:".section-toggle",elCountSections:".count-sections"};init(){this.elEditCurriculum=document.querySelector(`${EditCourseCurriculum.selectors.idElEditCurriculum}`),this.elCurriculumSections=this.elEditCurriculum.querySelector(`${EditCourseCurriculum.selectors.elCurriculumSections}`);const e=this.elEditCurriculum.closest(`${EditCourseCurriculum.selectors.LPTarget}`),t=window.lpAJAXG.getDataSetCurrent(e);this.courseId=t.args.course_id,this.editSectionItem.init(),this.events(),this.sortAbleSection()}events(){EditSection._loadedEvents||(EditSection._loadedEvents=this,lpUtils.eventHandlers("click",[{selector:EditSection.selectors.elBtnAddSection,class:this,callBack:this.addSection.name},{selector:`${EditSection.selectors.elBtnUpdateDes}`,class:this,callBack:this.updateSectionDescription.name},{selector:`${EditSection.selectors.etBtnEditTitle}`,class:this,callBack:this.setFocusTitleInput.name},{selector:`${EditSection.selectors.elSectionToggle}`,class:this,callBack:this.toggleSection.name},{selector:`${EditSection.selectors.elBtnCancelUpdateDes}`,class:this,callBack:this.cancelSectionDescription.name},{selector:`${EditSection.selectors.elBtnDeleteSection}`,class:this,callBack:this.deleteSection.name},{selector:`${EditSection.selectors.elBtnUpdateTitle}`,class:this,callBack:this.updateSectionTitle.name},{selector:`${EditSection.selectors.elBtnCancelUpdateTitle}`,class:this,callBack:this.cancelSectionTitle.name},{selector:EditCourseCurriculum.selectors.elToggleAllSections,class:this,callBack:this.toggleSectionAll.name}]),lpUtils.eventHandlers("keyup",[{selector:EditSection.selectors.elSectionTitleNewInput,class:this,callBack:this.changeTitleBeforeAdd.name},{selector:EditSection.selectors.elSectionTitleInput,class:this,callBack:this.changeTitle.name},{selector:EditSection.selectors.elSectionDesInput,class:this,callBack:this.changeDescription.name}]),lpUtils.eventHandlers("keydown",[{selector:EditSection.selectors.elSectionTitleNewInput,class:this,callBack:this.addSection.name,checkIsEventEnter:!0},{selector:EditSection.selectors.elSectionDesInput,class:this,callBack:this.updateSectionDescription.name,checkIsEventEnter:!0},{selector:EditSection.selectors.elSectionTitleInput,class:this,callBack:this.updateSectionTitle.name,checkIsEventEnter:!0}]),lpUtils.eventHandlers("focusin",[{selector:EditSection.selectors.elSectionTitleNewInput,class:this,callBack:this.focusTitleNewInput.name},{selector:EditSection.selectors.elSectionTitleInput,class:this,callBack:this.focusTitleInput.name}]),lpUtils.eventHandlers("focusout",[{selector:EditSection.selectors.elSectionTitleNewInput,class:this,callBack:this.focusTitleNewInput.name,focusIn:!1},{selector:`${EditSection.selectors.elSectionTitleInput}`,class:this,callBack:this.focusTitleInput.name,focusIn:!1}]))}changeTitleBeforeAdd(e){const{e:t,target:s}=e,l=s,c=l.closest(`${EditSection.selectors.elDivAddNewSection}`);if(!c)return;const o=c.querySelector(`${EditSection.selectors.elBtnAddSection}`);0===l.value.trim().length?o.classList.remove("active"):o.classList.add("active")}focusTitleNewInput(e){const{e:t,target:s,focusIn:l=!0}=e,c=s.closest(`${EditSection.selectors.elDivAddNewSection}`);c&&(l?c.classList.add("focus"):c.classList.remove("focus"))}addSection(e){const{e:t,target:s,callBackNest:l}=e,c=s.closest(`${EditSection.selectors.elDivAddNewSection}`);if(!c)return;t.preventDefault();const o=c.querySelector(`${EditSection.selectors.elSectionTitleNewInput}`),i=o.value.trim(),n=o.dataset.messEmptyTitle;if(0===i.length)return void lpToastify.show(n,"error");o.value="",o.blur();const r=this.elCurriculumSections.querySelector(`${EditSection.selectors.elSectionClone}`).cloneNode(!0);r.classList.remove("clone"),lpUtils.lpShowHideEl(r,1),lpUtils.lpSetLoadingEl(r,1);r.querySelector(`${EditSection.selectors.elSectionTitleInput}`).value=i,this.elCurriculumSections.insertAdjacentElement("beforeend",r);const a={success:t=>{const{message:s,status:c,data:o}=t;if("error"===c)throw r.remove(),s;if("success"===c){const{section:s}=o;r.dataset.sectionId=s.section_id||"",this.editSectionItem.sortAbleItem(),l&&"function"==typeof l.success&&(e.elSection=r,e.response=t,l.success(e))}lpToastify.show(s,c)},error:t=>{r.remove(),lpToastify.show(t,"error"),l&&"function"==typeof l.error&&(e.error=t,l.error(e))},completed:()=>{lpUtils.lpSetLoadingEl(r,0),r.classList.remove(`${EditCourseCurriculum.selectors.elCollapse}`);r.querySelector(`${EditSection.selectors.elSectionDesInput}`).focus(),this.updateCountSections(this.elEditCurriculum),l&&"function"==typeof l.completed&&(e.elSection=r,l.completed(e))}},u=JSON.parse(o.dataset.send);u.section_name=i,window.lpAJAXG.fetchAJAX(u,a)}deleteSection(e){const{e:t,target:s}=e,l=s,c=l.closest(`${EditCourseCurriculum.selectors.idElEditCurriculum}`);SweetAlert.fire({title:l.dataset.title,text:l.dataset.content,icon:"warning",showCloseButton:!0,showCancelButton:!0,cancelButtonText:lpData.i18n.cancel,confirmButtonText:lpData.i18n.yes,reverseButtons:!0}).then(e=>{if(e.isConfirmed){const e=l.closest(".section"),t=e.dataset.sectionId;lpUtils.lpSetLoadingEl(e,1);const s={success:e=>{const{message:t,status:s}=e;lpToastify.show(t,s)},error:e=>{lpToastify.show(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(e,0),e.remove(),this.editSectionItem.updateCountItems(e),this.updateCountSections(c)}},o=JSON.parse(l.dataset.send);o.section_id=t,window.lpAJAXG.fetchAJAX(o,s)}})}focusTitleInput(e){const{e:t,target:s,focusIn:l=!0}=e,c=s.closest(`${EditSection.selectors.elSection}`);c&&(l?c.classList.add("focus"):c.classList.remove("focus"))}setFocusTitleInput(e){const{e:t,target:s}=e,l=s.closest(`${EditSection.selectors.elSection}`);if(!l)return;const c=l.querySelector(`${EditSection.selectors.elSectionTitleInput}`);c.setSelectionRange(c.value.length,c.value.length),c.focus()}changeTitle(e){const{e:t,target:s}=e,l=s,c=l.closest(`${EditSection.selectors.elSection}`);l.value.trim()===(l.dataset.old||"")?c.classList.remove("editing"):c.classList.add("editing")}updateSectionTitle(e){const{e:t,target:s}=e,l=s.closest(`${EditSection.selectors.elSection}`);if(!l)return;t.preventDefault();const c=l.querySelector(`${EditSection.selectors.elSectionTitleInput}`);if(!c)return;const o=l.dataset.sectionId,i=c.value.trim(),n=c.dataset.old||"",r=c.dataset.messEmptyTitle;if(0===i.length)return void lpToastify.show(r,"error");if(i===n)return;c.blur(),lpUtils.lpSetLoadingEl(l,1);const a={success:e=>{const{message:t,status:s}=e;lpToastify.show(t,s),"success"===s&&(c.dataset.old=i)},error:e=>{lpToastify.show(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(l,0),l.classList.remove("editing")}},u=JSON.parse(c.dataset.send);u.section_id=o,u.section_name=i,window.lpAJAXG.fetchAJAX(u,a)}cancelSectionTitle(e){const{e:t,target:s}=e,l=s.closest(`${EditSection.selectors.elBtnCancelUpdateTitle}`);if(!l)return;const c=l.closest(`${EditSection.selectors.elSection}`),o=c.querySelector(`${EditSection.selectors.elSectionTitleInput}`);o.value=o.dataset.old||"",c.classList.remove("editing")}updateSectionDescription(e){const{e:t,target:s,callBackNest:l}=e,c=s.closest(`${EditSection.selectors.elSectionDesc}`);if(!c)return;const o=c.querySelector(`${EditSection.selectors.elSectionDesInput}`);if(!o)return;t.preventDefault();const i=o.closest(`${EditSection.selectors.elSection}`),n=i.dataset.sectionId,r=o.value.trim(),a=o.dataset.old||"";if(r===a)return;lpUtils.lpSetLoadingEl(i,1);const u={success:t=>{const{message:s,status:c}=t;l&&"function"==typeof l.success&&(e.elSection=i,e.response=t,l.success(e)),lpToastify.show(s,c)},error:e=>{lpToastify.show(e,"error"),l&&"function"==typeof l.error&&l.error(i,e)},completed:()=>{lpUtils.lpSetLoadingEl(i,0);o.closest(`${EditSection.selectors.elSectionDesc}`).classList.remove("editing"),o.dataset.old=r,l&&"function"==typeof l.completed&&l.completed(i)}},d=JSON.parse(o.dataset.send);d.section_id=n,d.section_description=r,window.lpAJAXG.fetchAJAX(d,u)}cancelSectionDescription(e){const{e:t,target:s}=e,l=s.closest(`${EditSection.selectors.elSectionDesc}`),c=l.querySelector(`${EditSection.selectors.elSectionDesInput}`);c.value=c.dataset.old||"",l.classList.remove("editing")}changeDescription(e){const{e:t,target:s}=e,l=s.closest(`${EditSection.selectors.elSectionDesInput}`);if(!l)return;const c=l.closest(`${EditSection.selectors.elSectionDesc}`);l.value.trim()===(l.dataset.old||"")?c.classList.remove("editing"):c.classList.add("editing")}toggleSectionAll(e){const{e:t,target:s}=e,l=s.closest(`${EditCourseCurriculum.selectors.elToggleAllSections}`);if(!l)return;const c=l.closest(`${EditCourseCurriculum.selectors.idElEditCurriculum}`).querySelectorAll(`${EditSection.selectors.elSection}:not(.clone)`);l.classList.toggle(`${EditCourseCurriculum.selectors.elCollapse}`),c.forEach(e=>{const t=l.classList.contains(`${EditCourseCurriculum.selectors.elCollapse}`);e.classList.toggle(`${EditCourseCurriculum.selectors.elCollapse}`,t)})}toggleSection(e){const{e:t,target:s}=e,l=s.closest(`${EditSection.selectors.elSection}`);l.closest(`${EditCourseCurriculum.selectors.elCurriculumSections}`)&&(l.classList.toggle(`${EditCourseCurriculum.selectors.elCollapse}`),this.checkAllSectionsCollapsed())}checkAllSectionsCollapsed(){const e=this.elEditCurriculum.querySelectorAll(`${EditSection.selectors.elSection}:not(.clone)`),t=this.elEditCurriculum.querySelector(`${EditCourseCurriculum.selectors.elToggleAllSections}`);let s=!0;e.forEach(e=>{if(e.classList.contains(`${EditCourseCurriculum.selectors.elCollapse}`))return s=!1,!1}),s?t.classList.remove(`${EditCourseCurriculum.selectors.elCollapse}`):t.classList.add(`${EditCourseCurriculum.selectors.elCollapse}`)}sortAbleSection(){let e,t=0;new Sortable(this.elCurriculumSections,{handle:".drag",animation:150,onEnd:s=>{const l=s.item;if(!t)return;const c=l.closest(`${EditSection.selectors.elSection}`),o=this.elCurriculumSections.querySelectorAll(`${EditSection.selectors.elSection}`),i=[];o.forEach(e=>{const t=e.dataset.sectionId;i.push(t)});const n={success:e=>{const{message:t,status:s}=e;lpToastify.show(t,s)},error:e=>{lpToastify.show(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(c,0),t=0}},r={action:"course_update_section_position",course_id:this.courseId,new_position:i,args:{id_url:"course-update-section-position"}};clearTimeout(e),e=setTimeout(()=>{lpUtils.lpSetLoadingEl(c,1),window.lpAJAXG.fetchAJAX(r,n)},1e3)},onMove:t=>{clearTimeout(e)},onUpdate:e=>{t=1}})}updateCountSections(e){const t=e.querySelector(`${EditSection.selectors.elCountSections}`),s=e.querySelectorAll(`${EditSection.selectors.elSection}:not(.clone)`).length;t.dataset.count=s,t.querySelector(".count").textContent=s}}