import SweetAlert from"sweetalert2";import Sortable from"sortablejs";import*as lpUtils from"lpAssetsJsPath/utils.js";import*as lpToastify from"lpAssetsJsPath/lpToastify.js";import{EditCourseCurriculum}from"../edit-curriculum.js";import{EditSection}from"./edit-section.js";import{LpPopupSelectItemToAdd}from"lpAssetsJsPath/lpPopupSelectItemToAdd.js";const idUrlHandle="edit-course-curriculum",lpPopupSelectItemToAdd=new LpPopupSelectItemToAdd;export class EditSectionItem{constructor(){this.courseId=null,this.elCurriculumSections=null,this.sectionIdSelected=null}static selectors={elSectionListItems:".section-list-items",elItemClone:".section-item.clone",elSectionItem:".section-item",elBtnSelectItemType:".lp-btn-select-item-type",elAddItemTypeClone:".lp-add-item-type.clone",elSectionActions:".section-actions",elAddItemType:".lp-add-item-type",elAddItemTypeTitleInput:".lp-add-item-type-title-input",elBtnAddItemCancel:".lp-btn-add-item-cancel",elBtnAddItem:".lp-btn-add-item",elItemTitleInput:".lp-item-title-input",elBtnUpdateItemTitle:".lp-btn-update-item-title",elBtnCancelUpdateTitle:".lp-btn-cancel-update-item-title",elBtnDeleteItem:".lp-btn-delete-item",elBtnSetPreviewItem:".lp-btn-set-preview-item"};init(){this.elEditCurriculum=document.querySelector(`${EditCourseCurriculum.selectors.idElEditCurriculum}`),this.elCurriculumSections=this.elEditCurriculum.querySelector(`${EditCourseCurriculum.selectors.elCurriculumSections}`);const e=this.elEditCurriculum.closest(`${EditCourseCurriculum.selectors.LPTarget}`),t=window.lpAJAXG.getDataSetCurrent(e);this.courseId=t.args.course_id,this.events(),this.sortAbleItem(),lpPopupSelectItemToAdd.init()}events(){EditSectionItem._loadedEvents||(EditSectionItem._loadedEvents=this,lpUtils.eventHandlers("click",[{selector:EditSectionItem.selectors.elBtnSelectItemType,class:this,callBack:this.addItemType.name},{selector:EditSectionItem.selectors.elBtnAddItem,class:this,callBack:this.addItemToSection.name},{selector:EditSectionItem.selectors.elBtnAddItemCancel,class:this,callBack:this.cancelAddItemType.name},{selector:EditSectionItem.selectors.elBtnUpdateItemTitle,class:this,callBack:this.updateTitle.name},{selector:EditSectionItem.selectors.elBtnCancelUpdateTitle,class:this,callBack:this.cancelUpdateTitle.name},{selector:EditSectionItem.selectors.elBtnDeleteItem,class:this,callBack:this.deleteItem.name},{selector:LpPopupSelectItemToAdd.selectors.elBtnShowPopupItemsToSelect,callBack:e=>{const{e:t,target:s}=e,l=s.closest(EditSection.selectors.elSection);this.sectionIdSelected=l.dataset.sectionId}},{selector:LpPopupSelectItemToAdd.selectors.elBtnAddItemsSelected,class:lpPopupSelectItemToAdd,callBack:lpPopupSelectItemToAdd.addItemsSelectedToSection.name,callBackHandle:this.addItemsSelectedToSection.bind(this)},{selector:EditSectionItem.selectors.elBtnSetPreviewItem,class:this,callBack:this.updatePreviewItem.name}]),lpUtils.eventHandlers("keyup",[{selector:EditSectionItem.selectors.elItemTitleInput,class:this,callBack:this.changeTitle.name},{selector:EditSectionItem.selectors.elAddItemTypeTitleInput,class:this,callBack:this.changeTitleAddNew.name}]),lpUtils.eventHandlers("keydown",[{selector:EditSectionItem.selectors.elAddItemTypeTitleInput,class:this,callBack:this.addItemToSection.name,checkIsEventEnter:!0},{selector:EditSectionItem.selectors.elItemTitleInput,class:this,callBack:this.updateTitle.name,checkIsEventEnter:!0}]),lpUtils.eventHandlers("focusin",[{selector:EditSectionItem.selectors.elItemTitleInput,class:this,callBack:this.focusTitleInput.name}]),lpUtils.eventHandlers("focusout",[{selector:EditSectionItem.selectors.elItemTitleInput,class:this,callBack:this.focusTitleInput.name,focusIn:!1}]))}addItemType(e){const{e:t,target:s}=e,l=s,i=l.dataset.itemType,o=l.dataset.placeholder,c=l.dataset.buttonAddText,n=l.closest(`${EditSection.selectors.elSection}`).querySelector(`${EditSectionItem.selectors.elSectionActions}`),d=n.querySelector(`${EditSectionItem.selectors.elAddItemTypeClone}`).cloneNode(!0),r=d.querySelector(`${EditSectionItem.selectors.elAddItemTypeTitleInput}`),a=d.querySelector(`${EditSectionItem.selectors.elBtnAddItem}`);d.classList.remove("clone"),d.classList.add(i),lpUtils.lpShowHideEl(d,1),r.setAttribute("placeholder",o),r.dataset.itemType=i,a.textContent=c,n.insertAdjacentElement("beforebegin",d),r.focus()}cancelAddItemType(e){const{e:t,target:s}=e,l=s.closest(`${EditSectionItem.selectors.elAddItemType}`);l&&l.remove()}addItemToSection(e){const{e:t,target:s,callBackNest:l}=e;t.preventDefault();const i=s.closest(`${EditSectionItem.selectors.elAddItemType}`),o=i.closest(`${EditSection.selectors.elSection}`),c=o.dataset.sectionId,n=i.querySelector(`${EditSectionItem.selectors.elAddItemTypeTitleInput}`),d=n.value.trim(),r=n.dataset.itemType,a=n.dataset.messEmptyTitle;if(0===d.length)return void lpToastify.show(a,"error");const m=o.querySelector(`${EditSectionItem.selectors.elItemClone}`),u=m.cloneNode(!0),p=u.querySelector(`${EditSectionItem.selectors.elItemTitleInput}`);u.classList.remove("clone"),u.classList.add(r),u.dataset.itemType=r,lpUtils.lpShowHideEl(u,1),lpUtils.lpSetLoadingEl(u,1),p.value=d,p.dataset.old=d,m.insertAdjacentElement("beforebegin",u),i.remove();const I={success:t=>{const{message:s,status:i,data:o}=t;if(lpToastify.show(s,i),"error"===i)u.remove();else if("success"===i){const{section_item:t,item_link:s}=o||{};u.dataset.itemId=t.item_id||0,u.querySelector(".edit-link").setAttribute("href",s||""),l&&"function"==typeof l.success&&(e.elItemNew=u,l.success(e))}},error:e=>{lpToastify.show(e,"error"),u.remove()},completed:()=>{lpUtils.lpSetLoadingEl(u,0),this.updateCountItems(o),l&&"function"==typeof l.completed&&(e.elItemNew=u,l.completed(e))}},S={course_id:this.courseId,action:"create_item_add_to_section",section_id:c,item_title:d,item_type:r,args:{id_url:idUrlHandle}};window.lpAJAXG.fetchAJAX(S,I)}changeTitle(e){const{target:t}=e,s=t.closest(`${EditSectionItem.selectors.elItemTitleInput}`);if(!s)return;const l=s.closest(`${EditSectionItem.selectors.elSectionItem}`);if(!l)return;s.value.trim()===(s.dataset.old||"")?l.classList.remove("editing"):l.classList.add("editing")}focusTitleInput(e){const{target:t,focusIn:s=!0}=e,l=t.closest(`${EditSectionItem.selectors.elItemTitleInput}`);if(!l)return;const i=l.closest(`${EditSectionItem.selectors.elSectionItem}`);i&&(s?i.classList.add("focus"):i.classList.remove("focus"))}changeTitleAddNew(e){const{target:t}=e,s=t.closest(`${EditSectionItem.selectors.elAddItemTypeTitleInput}`);if(!s)return;const l=s.closest(`${EditSectionItem.selectors.elAddItemType}`);if(!l)return;const i=l.querySelector(`${EditSectionItem.selectors.elBtnAddItem}`);if(!i)return;0===s.value.trim().length?i.classList.remove("active"):i.classList.add("active")}updateTitle(e){const{e:t,target:s}=e;t.preventDefault();const l=s.closest(`${EditSectionItem.selectors.elSectionItem}`);if(!l)return;const i=l.closest(`${EditSection.selectors.elSection}`);if(!i)return;const o=l.querySelector(`${EditSectionItem.selectors.elItemTitleInput}`);if(!o)return;const c=l.dataset.itemId,n=l.dataset.itemType,d=o.value.trim(),r=o.dataset.old,a=o.dataset.messEmptyTitle;if(0===d.length)return void lpToastify.show(a,"error");if(d===r)return;o.blur(),lpUtils.lpSetLoadingEl(l,1);const m={success:e=>{const{message:t,status:s}=e;"success"===s?o.dataset.old=d:o.value=r,lpToastify.show(t,s)},error:e=>{lpToastify.show(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(l,0),l.classList.remove("editing")}},u={course_id:this.courseId,action:"update_item_of_section",section_id:i.dataset.sectionId,item_id:c,item_type:n,item_title:d,args:{id_url:idUrlHandle}};window.lpAJAXG.fetchAJAX(u,m)}cancelUpdateTitle(e){const{e:t,target:s}=e,l=s.closest(`${EditSectionItem.selectors.elBtnCancelUpdateTitle}`);if(!l)return;const i=l.closest(`${EditSectionItem.selectors.elSectionItem}`),o=i.querySelector(`${EditSectionItem.selectors.elItemTitleInput}`);o.value=o.dataset.old||"",i.classList.remove("editing")}deleteItem(e){const{e:t,target:s}=e,l=s.closest(`${EditSectionItem.selectors.elBtnDeleteItem}`);if(!l)return;const i=l.closest(`${EditSectionItem.selectors.elSectionItem}`);if(!i)return;const o=i.dataset.itemId,c=i.closest(`${EditSection.selectors.elSection}`),n=c.dataset.sectionId;SweetAlert.fire({title:l.dataset.title,text:l.dataset.content,icon:"warning",showCloseButton:!0,showCancelButton:!0,cancelButtonText:lpDataAdmin.i18n.cancel,confirmButtonText:lpDataAdmin.i18n.yes,reverseButtons:!0}).then(e=>{if(e.isConfirmed){lpUtils.lpSetLoadingEl(i,1);const e={success:e=>{const{message:t,status:s}=e;lpToastify.show(t,s),"success"===s&&i.remove()},error:e=>{lpToastify.show(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(i,0),this.updateCountItems(c)}},t={course_id:this.courseId,action:"delete_item_from_section",section_id:n,item_id:o,args:{id_url:idUrlHandle}};window.lpAJAXG.fetchAJAX(t,e)}})}sortAbleItem(){const e=this.elCurriculumSections.querySelectorAll(`${EditSectionItem.selectors.elSectionListItems}`);let t,s=0,l=0,i=0;e.forEach(e=>{new Sortable(e,{handle:".drag",animation:150,group:{name:"shared"},onEnd:e=>{const o=[],c=e.item;i=c.closest(`${EditSection.selectors.elSection}`).dataset.sectionId;const n={course_id:this.courseId,args:{id_url:idUrlHandle},action:"update_item_section_and_position"};n.item_id_change=s,n.section_id_new_of_item=i,n.section_id_old_of_item=l;const d=this.elCurriculumSections.querySelector(`.section[data-section-id="${i}"]`);d.querySelectorAll(`${EditSectionItem.selectors.elSectionItem}`).forEach(e=>{const t=parseInt(e.dataset.itemId||0);0!==t&&o.push(t)}),n.items_position=o;const r={success:e=>{const{message:t,status:s}=e;lpToastify.show(t,s)},error:e=>{lpToastify.show(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(c,0),this.updateCountItems(d),l!==i&&this.updateCountItems(t)}};lpUtils.lpSetLoadingEl(c,1),window.lpAJAXG.fetchAJAX(n,r)},onMove:()=>{},onChoose:e=>{const i=e.item;s=i.dataset.itemId,t=i.closest(`${EditSection.selectors.elSection}`),l=t.dataset.sectionId},onUpdate:()=>{}})})}addItemsSelectedToSection(e){const t=document.querySelector(`.section[data-section-id="${this.sectionIdSelected}"]`),s=t.querySelector(`${EditSectionItem.selectors.elItemClone}`);e.forEach(e=>{const t=s.cloneNode(!0),l=t.querySelector(`${EditSectionItem.selectors.elItemTitleInput}`);t.dataset.itemId=e.id,t.classList.add(e.type),t.classList.remove("clone"),t.dataset.itemType=e.type,t.querySelector(".edit-link").setAttribute("href",e.editLink||""),l.value=e.titleSelected||"",lpUtils.lpSetLoadingEl(t,1),lpUtils.lpShowHideEl(t,1),s.insertAdjacentElement("beforebegin",t)}),SweetAlert.close();const l={course_id:this.courseId,action:"add_items_to_section",section_id:this.sectionIdSelected,items:e,args:{id_url:idUrlHandle}};window.lpAJAXG.fetchAJAX(l,{success:l=>{const{message:i,status:o,data:c}=l,{html:n}=c||"";lpToastify.show(i,o),e.forEach(e=>{const s=t.querySelector(`${EditSectionItem.selectors.elSectionItem}[data-item-id="${e.id}"]`);s&&s.remove()}),"success"===o&&s.insertAdjacentHTML("beforebegin",n)},error:e=>{lpToastify.show(e,"error")},completed:()=>{this.updateCountItems(t)}})}updatePreviewItem(e){const{e:t,target:s}=e,l=s.closest(`${EditSectionItem.selectors.elBtnSetPreviewItem}`);if(!l)return;const i=l.closest(`${EditSectionItem.selectors.elSectionItem}`);if(!i)return;const o=l.querySelector("a");o.classList.toggle("lp-icon-eye"),o.classList.toggle("lp-icon-eye-slash");const c=!o.classList.contains("lp-icon-eye-slash"),n=i.dataset.itemId,d=i.dataset.itemType;lpUtils.lpSetLoadingEl(i,1);const r={success:e=>{const{message:t,status:s}=e;lpToastify.show(t,s),"error"===s&&(o.classList.toggle("lp-icon-eye"),o.classList.toggle("lp-icon-eye-slash"))},error:e=>{lpToastify.show(e,"error"),o.classList.toggle("lp-icon-eye"),o.classList.toggle("lp-icon-eye-slash")},completed:()=>{lpUtils.lpSetLoadingEl(i,0)}},a={course_id:this.courseId,action:"update_item_preview",item_id:n,item_type:d,enable_preview:c?1:0,args:{id_url:idUrlHandle}};window.lpAJAXG.fetchAJAX(a,r)}updateCountItems(e){const t=this.elEditCurriculum,s=t.querySelector(".total-items"),l=t.querySelectorAll(`${EditSectionItem.selectors.elSectionItem}:not(.clone)`).length;s.dataset.count=l,s.querySelector(".count").textContent=l;const i=e.querySelector(".section-items-counts"),o=e.querySelectorAll(`${EditSectionItem.selectors.elSectionItem}:not(.clone)`).length;i.dataset.count=o,i.querySelector(".count").textContent=o}}