import*as lpUtils from"lpAssetsJsPath/utils.js";import SweetAlert from"sweetalert2";import*as lpToastify from"lpAssetsJsPath/lpToastify.js";let lp_structure_course,lp_is_generating_course_data=!1;const lp_course_ai_setting=JSON.parse(localStorage.getItem("lp_course_ai_setting"))||{};export class CreateCourseViaAI{constructor(){this.init()}static selectors={elGenerateDataAiWrap:".lp-generate-data-ai-wrap"};init(){lpData?.enable_open_ai?lpUtils.lpOnElementReady(".page-title-action",e=>{e.insertAdjacentHTML("afterend",`<button type="button" class="lp-btn-generate-course-with-ai lp-btn-ai-style">\n\t\t\t\t\t<i class="lp-ico-ai"></i>\n\t\t\t\t\t<span>${lpData.i18n.generate_with_ai}</span>\n\t\t\t\t</button>`)}):lpUtils.lpOnElementReady(".page-title-action",e=>{e.insertAdjacentHTML("afterend",`<button type="button" class="lp-btn-warning-enable-ai lp-btn-ai-style">\n\t\t\t\t\t<i class="lp-ico-ai"></i>\n\t\t\t\t\t<span>${lpData.i18n.generate_with_ai}</span>\n\t\t\t\t</button>`)}),this.events()}events(){CreateCourseViaAI._loadedEvents||(CreateCourseViaAI._loadedEvents=!0,lpUtils.eventHandlers("click",[{selector:".lp-btn-warning-enable-ai",class:this,callBack:this.showPopupEnableAI.name},{selector:".lp-btn-generate-course-with-ai",class:this,callBack:this.showPopupCreateFullCourse.name},{selector:".lp-btn-step",class:this,callBack:this.showStep.name},{selector:".lp-btn-generate-prompt",class:this,callBack:this.generatePrompt.name},{selector:".lp-btn-call-open-ai",class:this,callBack:this.generateDataCourse.name},{selector:".lp-btn-create-course",class:this,callBack:this.createCourse.name},{selector:".lp-btn-close-ai-popup",callBack:e=>{const{e:t,target:s}=e,a=lpData.i18n.confirm_close_ai;lp_is_generating_course_data?confirm(a)&&SweetAlert.close():SweetAlert.close()}}]))}showPopupEnableAI(){const e=document.querySelector("#lp-tmpl-must-enable-ai");e?SweetAlert.fire({html:e.innerHTML,width:"420px",showCloseButton:!1,showConfirmButton:!1}):console.error("Enable OpenAI Modal Template not found!")}showPopupCreateFullCourse(){const e=document.querySelector("#lp-tmpl-create-course-ai");e?SweetAlert.fire({html:e.innerHTML,width:"60%",showCloseButton:!1,showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>{const e=SweetAlert.getPopup();e.click();const t=e.querySelector('select[name="target_audience"]');t&&lp_course_ai_setting?.target_audience&&t.tomselect.setValue(lp_course_ai_setting.target_audience);const s=e.querySelector('select[name="tone"]');s&&lp_course_ai_setting?.tone&&s.tomselect.setValue(lp_course_ai_setting.tone);const a=e.querySelector('select[name="language"]');a&&lp_course_ai_setting?.language&&a.tomselect.setValue(lp_course_ai_setting.language),t.addEventListener("change",e=>{lp_course_ai_setting.target_audience=t.tomselect.getValue(),localStorage.setItem("lp_course_ai_setting",JSON.stringify(lp_course_ai_setting))}),s.addEventListener("change",e=>{lp_course_ai_setting.tone=s.tomselect.getValue(),localStorage.setItem("lp_course_ai_setting",JSON.stringify(lp_course_ai_setting))}),a.addEventListener("change",e=>{const t=a.tomselect.getValue();lp_course_ai_setting.language=t?[t]:[],localStorage.setItem("lp_course_ai_setting",JSON.stringify(lp_course_ai_setting))})}}).then(e=>{e.isDismissed&&lp_is_generating_course_data&&(lp_is_generating_course_data=!1)}):console.error("AI Create Full Course Modal Template not found!")}showStep(e){const{e:t,target:s}=e;t.preventDefault();const a=s.closest(".button-actions"),l=a.closest(CreateCourseViaAI.selectors.elGenerateDataAiWrap);let o=parseInt(a.dataset.step);const r=s.dataset.action;"next"===r?o++:"prev"===r&&o--,a.dataset.step=o;const n=s.closest("form"),i=n.querySelector(`.step-content[data-step="${o}"]`),c=l.querySelector(`.step-item[data-step="${o}"]`);n.querySelectorAll(".step-content").forEach(e=>e.classList.remove("active")),i.classList.add("active"),l.querySelectorAll(".step-item").forEach(e=>e.classList.remove("active")),c.classList.add("active");s.closest("form").querySelectorAll("button[data-step-show]").forEach(e=>{e.dataset.stepShow.split(",").map(e=>parseInt(e.trim())).includes(o)?lpUtils.lpShowHideEl(e,1):lpUtils.lpShowHideEl(e,0)})}generatePrompt(e){const{e:t,target:s}=e;t.preventDefault(),lpUtils.lpSetLoadingEl(s,!0);const a=s.closest("form");let l=JSON.parse(s.dataset.send);l=lpUtils.mergeDataWithDatForm(a,l);const o={success:e=>{const{message:t,status:s,data:l}=e;if(lpToastify.show(t,s),"success"===s){a.querySelector(".lp-btn-step[data-action=next]").click();a.querySelector("textarea[name=lp-openai-prompt-generated-field]").value=l}},error:e=>{lpToastify.show(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(s,!1)}};window.lpAJAXG.fetchAJAX(l,o)}generateDataCourse(e){const{e:t,target:s}=e;t.preventDefault(),lpUtils.lpSetLoadingEl(s,!0);const a=s.closest("form");let l=JSON.parse(s.dataset.send);l=lpUtils.mergeDataWithDatForm(a,l);const o=a.querySelector(".lp-btn-step[data-action=prev]");lpUtils.lpShowHideEl(o,0);const r={success:e=>{const{message:t,status:s,data:l}=e;if(lp_is_generating_course_data&&lpToastify.show(t,s),"success"===s){lp_structure_course=l.lp_structure_course;a.querySelector(".lp-ai-generated-results").innerHTML=l.lp_html_preview;a.querySelector(".lp-btn-step[data-action=next]").click()}},error:e=>{lpToastify.show(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(s,!1),lpUtils.lpShowHideEl(o,1),lp_is_generating_course_data=!1}};lp_is_generating_course_data=!0,window.lpAJAXG.fetchAJAX(l,r)}createCourse(e){const{e:t,target:s}=e;t.preventDefault(),lpUtils.lpSetLoadingEl(s,!0);const a=JSON.parse(s.dataset.send);a.lp_structure_course=lp_structure_course;const l=s.closest("form").querySelector(".lp-btn-step[data-action=prev]");lpUtils.lpShowHideEl(l,0);let o;o=window.outerWidth<768?"90%":"30%";const r=document.querySelector("#lp-tmpl-creating-course-ai");SweetAlert.fire({html:r.innerHTML,showCloseButton:!1,showConfirmButton:!1,allowOutsideClick:!1,width:o});const n={success:e=>{const{message:t,status:s,data:a}=e;SweetAlert.close(),lpToastify.show(t,s),"success"===s?setTimeout(()=>{window.location.href=a.edit_course_url},2e3):lpUtils.lpShowHideEl(l,1)},error:e=>{lpToastify.show(e,"error"),lpUtils.lpShowHideEl(l,1)},completed:()=>{lpUtils.lpSetLoadingEl(s,!1)}};window.lpAJAXG.fetchAJAX(a,n)}}